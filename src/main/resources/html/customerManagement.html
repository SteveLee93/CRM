<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>고객 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      overflow-x: hidden;
      background-color: #f8f9fa;
    }

    .page-wrapper {
      min-height: 100vh;
      padding: 20px 40px;
      background-color: #f8f9fa;
    }

    .main-content {
      margin-left: 250px;
      padding-top: 40px;
      transition: margin-left 0.3s ease;
    }

    /* 카드 스타일 */
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .card-header {
      background: linear-gradient(45deg, #1e3c72, #2a5298);
      color: white;
      border-radius: 15px 15px 0 0 !important;
      padding: 1rem 1.5rem;
    }

    /* 검색 입력창 스타일 */
    #searchInput {
      min-width: 200px;
    }

    /* select 박스 스타일 */
    #searchType {
      min-width: 50px;
      width: auto;
    }

    /* input-group 전체 너비 */
    .input-group {
      min-width: 300px;
    }

    /* 정렬 관련 스타일 */
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 25px !important;
      text-align: center !important;
    }

    .sortable i,
    .sortable::after {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }

    .sortable i {
      margin-left: 5px;
      color: #ccc;
      transition: all 0.2s ease;
    }

    /* 기본 정렬 아이콘 */
    .sortable i.fa-sort {
      opacity: 0.3;
    }

    /* 오름차순 정렬 시 */
    .sortable.asc i.fa-sort {
      display: none;
    }

    .sortable.asc::after {
      content: '\f0d8';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-left: 5px;
      color: #1e3c72;
    }

    /* 내림차순 정렬 시 */
    .sortable.desc i.fa-sort {
      display: none;
    }

    .sortable.desc::after {
      content: '\f0d7';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-left: 5px;
      color: #1e3c72;
    }

    /* 반응형 디자인 */
    @media (max-width: 991.98px) {
      .main-content {
        margin-left: 0;
      }

      #sidebarContainer {
        display: none;
      }
    }

    /* 사이드바 관련 스타일 추가 */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background: linear-gradient(45deg, #1e3c72, #2a5298);
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed {
      margin-left: -250px;
    }

    .main-content {
      margin-left: 250px;
      transition: margin-left 0.3s ease;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    @media (max-width: 991.98px) {
      .main-content {
        margin-left: 0;
      }

      .sidebar {
        margin-left: -250px;
      }

      .sidebar.show {
        margin-left: 0;
      }
    }

    /* 사이드바 관련 스타일 수정 */
    .toggle-sidebar {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1001;
    }

    /* 모바일 대응 */
    @media (max-width: 991.98px) {
      .page-wrapper {
        padding: 15px 20px;
      }

      .main-content {
        margin-left: 0;
        padding-top: 40px;
      }

      .toggle-sidebar {
        display: block !important;
      }
    }

    /* 페이지네이션 버튼 스타일 추가 */
    .pagination .page-link {
      min-width: 36px;
      /* 두 자리 숫자를 기준으로 한 너비 */
      text-align: center;
      padding: 6px 6px;
      /* 좌우 패딩 조정 */
    }

    /* 처음/마지막 버튼의 아이콘 정렬 */
    .pagination .page-link i {
      display: inline-block;
      width: 14px;
      /* 아이콘 너비 고정 */
      text-align: center;
    }

    /* 예약 모달 스타일 */
    #reservationModal .modal-content {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    #reservationModal .modal-header {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      border-radius: 15px 15px 0 0;
      padding: 1rem 1.5rem;
    }

    #reservationModal .modal-title {
      font-weight: 600;
      font-size: 1.2rem;
    }

    #reservationModal .table {
      margin-bottom: 0;
      table-layout: fixed;
      /* 추가: 테이블 레이아웃 고정 */
      width: 100%;
    }

    #reservationModal .table th,
    #reservationModal .table td {
      padding: 12px 8px;
      white-space: nowrap;
      /* 추가: 텍스트 줄바꿈 방지 */
      overflow: hidden;
      /* 추가: 넘치는 텍스트 숨김 */
      text-overflow: ellipsis;
      /* 추가: 넘치는 텍스트에 ... 표시 */
    }

    #reservationModal .table th {
      background-color: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      font-size: 0.95rem;
    }

    #reservationModal .table td {
      vertical-align: middle;
      font-size: 0.95rem;
    }

    #reservationModal .table-hover tbody tr:hover {
      background-color: #f8f9fa;
    }

    #noReservationMessage {
      color: #6c757d;
      padding: 2rem;
    }

    #noReservationMessage i {
      color: #dee2e6;
    }

    #reservationModal .btn-secondary {
      background-color: #6c757d;
      border: none;
      padding: 8px 20px;
      font-weight: 500;
    }

    #reservationModal .btn-secondary:hover {
      background-color: #5a6268;
    }

    #reservationModal .modal-footer {
      border-top: 1px solid #eee;
      padding: 1rem 1.5rem;
    }

    /* 예약 모달 스타일 추가 */
    #reservationModal .modal-xl {
      max-width: 1200px;
      /* 모달 최대 너비 설정 */
    }

    #reservationModal .table td {
      vertical-align: middle;
      padding: 12px 8px;
    }

    #reservationModal .btn-action-group {
      white-space: nowrap;
    }

    /* 관리 버튼 스타일 */
    .reservation-actions .btn {
      padding: 6px 12px;
      margin: 0 2px;
    }

    .reservation-actions .btn i {
      margin-right: 4px;
    }

    /* 모바일 대응 */
    @media (max-width: 768px) {
      #reservationModal .modal-dialog {
        margin: 0.5rem;
      }

      #reservationModal .table th,
      #reservationModal .table td {
        font-size: 0.85rem;
        padding: 8px 4px;
      }
    }

    /* 버튼 스타일 수정 */
    .btn-info {
      background-color: #0dcaf0;
      border-color: #0dcaf0;
      color: white;
      font-weight: 600;
      /* 볼드체 추가 */
      letter-spacing: -0.3px;
      /* 자간 살짝 조정 */
    }

    .btn-info:hover {
      background-color: #31d2f2;
      border-color: #25cff2;
      color: white;
    }

    /* 버튼 크기 조정 */
    .btn-sm {
      padding: 0.25rem 0.8rem;
      /* 좌우 패딩 살짝 증가 */
      font-size: 0.875rem;
      line-height: 1.5;
      border-radius: 0.2rem;
    }

    /* 사용 불가능한 객실 스타일 */
    .room-unavailable {
      color: #adb5bd;
      font-style: italic;
    }

    .room-unavailable::after {
      content: ' (선택 불가)';
      font-size: 0.9em;
    }

    #editRoomSelect option:disabled {
      background-color: #f8f9fa;
    }

    .room-unavailable {
      color: #adb5bd !important;
      font-style: italic;
    }

    #editRoomSelect option:disabled {
      background-color: #f8f9fa;
    }

    #editRoomSelect option {
      padding: 8px;
    }
  </style>
</head>

<body>
  <!-- 사이드바가 로드될 컨테이너 -->
  <div id="sidebarContainer"></div>

  <!-- 전체 컨텐츠를 감싸는 wrapper -->
  <div class="page-wrapper">
    <!-- 메인 컨텐츠 -->
    <div class="main-content">
      <div class="container-fluid">
        <!-- 검색 및 필터링 -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">고객 관리</h5>
            <div class="d-flex gap-2">
              <div class="input-group" style="width: auto;">
                <select class="form-select" id="searchType">
                  <option value="all">전체</option>
                  <option value="username">아이디</option>
                  <option value="name">이름</option>
                  <option value="email">이메일</option>
                </select>
                <input type="text" class="form-control" id="searchInput" placeholder="검색어를 입력하세요">
              </div>
              <button class="btn btn-primary" id="addCustomerBtn">
                <i class="fas fa-plus"></i> 고객 추가
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="id">ID <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="username">아이디 <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="name">이름 <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="email">이메일 <i class="fas fa-sort"></i></th>
                    <th>관리</th>
                  </tr>
                </thead>
                <tbody id="customerTableBody">
                  <!-- 고객 데이터는 JavaScript로 동적 추가됨 -->
                </tbody>
              </table>
            </div>
            <!-- 페이지네이션 -->
            <nav>
              <ul class="pagination justify-content-center" id="pagination">
                <!-- 페이지네이션은 JavaScript로 동적 추가됨 -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 고객 추가 모달 -->
  <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">새 고객 추가</h5>
          <button type="button" class="btn-close" onclick="cancelAdd()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="addUsername" class="form-label">아이디 *</label>
            <input type="text" class="form-control" id="addUsername" oninput="checkUsernameReal(this.value)">
            <div id="usernameCheck" class="form-text"></div>
          </div>
          <div class="mb-3">
            <label for="addPassword" class="form-label">비밀번호 *</label>
            <input type="password" class="form-control" id="addPassword">
          </div>
          <div class="mb-3">
            <label for="addName" class="form-label">이름 *</label>
            <input type="text" class="form-control" id="addName">
          </div>
          <div class="mb-3">
            <label for="addEmail" class="form-label">이메일 *</label>
            <input type="email" class="form-control" id="addEmail" oninput="checkEmailReal(this.value)">
            <div id="emailCheck" class="form-text"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cancelAdd()">취소</button>
          <button type="button" class="btn btn-primary" onclick="addCustomer()">추가</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 예약 확인 모달 수정 -->
  <div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-xl"> <!-- modal-lg에서 modal-xl로 변경 -->
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="reservationModalLabel"></h5>
        </div>
        <div class=" modal-body p-4">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="text-center" style="width: 10%">객실 호수</th>
                  <th class="text-center" style="width: 10%">객실 타입</th>
                  <th class="text-center" style="width: 18%">체크인</th>
                  <th class="text-center" style="width: 18%">체크아웃</th>
                  <th class="text-center" style="width: 24%">예약일시</th>
                  <th class="text-center" style="width: 20%">관리</th>
                </tr>
              </thead>
              <tbody id="reservationTableBody">
              </tbody>
            </table>
            <div id="noReservationMessage" class="text-center py-4 text-muted d-none">
              <i class="fas fa-calendar-times fa-2x mb-3"></i>
              <p class="mb-0">예약 내역이 없습니다.</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeReservationModal()"
            data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 예약 수정 모달 수정 -->
  <div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">예약 수정</h5>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editReservationId">
          <div class="mb-3">
            <label class="form-label">객실 선택</label>
            <select class="form-select" id="editRoomSelect">
              <option value="">객실을 선택해주세요</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">체크인 날짜</label>
            <input type="date" class="form-control" id="editCheckinDate">
          </div>
          <div class="mb-3">
            <label class="form-label">체크아웃 날짜</label>
            <input type="date" class="form-control" id="editCheckoutDate">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="updateReservation()">수정</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 고객 수정 모달 -->
  <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">고객 정보 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="mb-3">
            <label for="editUsername" class="form-label">아이디</label>
            <input type="text" class="form-control" id="editUsername" readonly>
          </div>
          <div class="mb-3">
            <label for="editName" class="form-label">이름 *</label>
            <input type="text" class="form-control" id="editName">
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">이메일 *</label>
            <input type="email" class="form-control" id="editEmail" oninput="checkEditEmailReal(this.value)">
            <div id="editEmailCheck" class="form-text"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="updateCustomer()">수정</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let totalCustomers = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let isUsernameAvailable = false;
    let isEmailAvailable = false;
    let originalCustomerData = null;

    // 예약 확인 모달 닫기 함수 추가
    function closeReservationModal() {
      if (currentModal) {
        document.body.focus();
        currentModal.hide();
        currentModal = null;
      }
    }

    // 예약 확인 모달 관리를 위한 전역 변수
    let currentModal = null;

    // 예약 확인 함수
    async function checkReservation(customerId) {
      try {
        const response = await fetch(`/api/reservation/customer/${customerId}`);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || '예약 정보를 불러올 수 없습니다.');
        }

        const reservations = await response.json();
        currentReservations = reservations;

        // 모달 요소 가져오기
        const modalElement = document.getElementById('reservationModal');

        // 테이블 내용 생성
        const tableContent = `
            <div class="table-responsive">
                <table class="table table-hover" id="reservationTable">
                    <thead>
                        <tr>
                            <th>객실 번호</th>
                            <th>객실 타입</th>
                            <th>체크인</th>
                            <th>체크아웃</th>
                            <th>예약일</th>>
                        </tr>
                    </thead>
                    <tbody>
                        ${reservations.length === 0 ? `
                            <tr>
                                <td colspan="6" class="text-center">
                                    <i class="fas fa-info-circle me-2"></i>예약 내역이 없습니다.
                                </td>
                            </tr>
                        ` : reservations.map(reservation => `
                            <tr>
                                <td>${reservation.roomNumber}호</td>
                                <td>${getRoomTypeText(reservation.roomType)}</td>
                                <td>${formatDate(reservation.checkinDt)}</td>
                                <td>${formatDate(reservation.checkoutDt)}</td>
                                <td>${formatDate(reservation.reservationDt)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        modalElement.querySelector('.modal-body').innerHTML = tableContent;

        const modal = new bootstrap.Modal(modalElement);
        modal.show();

      } catch (error) {
        console.error('Error:', error);
        alert('예약 정보를 불러오는데 실패했습니다: ' + error.message);
      }
    }
    // 예약 수정 모달 열기
    async function editReservationModal(reservationId) {
      try {
        console.log('Opening modal for reservation:', reservationId);

        // 현재 예약 목록에서 해당 예약 찾기
        const reservation = currentReservations.find(r => r.id === reservationId);

        if (!reservation) {
          console.error('Reservation not found:', reservationId);
          throw new Error('예약 정보를 찾을 수 없습니다.');
        }

        console.log('Found reservation:', reservation);

        // 모달 필드 설정
        document.getElementById('editReservationId').value = reservationId;
        document.getElementById('editCheckinDate').value = reservation.checkinDt.split(' ')[0];
        document.getElementById('editCheckoutDate').value = reservation.checkoutDt.split(' ')[0];

        // 기존 선택된 객실 번호 저장
        const currentRoomNumber = reservation.roomNumber;
        console.log('Current room number:', currentRoomNumber);

        // 날짜 입력 필드에 이벤트 리스너 추가
        const dateFields = ['editCheckinDate', 'editCheckoutDate'];
        dateFields.forEach(fieldId => {
          const element = document.getElementById(fieldId);
          element.removeEventListener('change', updateAvailableRooms);
          element.addEventListener('change', updateAvailableRooms);
        });

        // 사용 가능한 객실 목록 업데이트
        await updateAvailableRooms();

        // 현재 객실 선택
        const roomSelect = document.getElementById('editRoomSelect');
        if (roomSelect.querySelector(`option[value="${currentRoomNumber}"]`)) {
          roomSelect.value = currentRoomNumber;
        }

        // 모달 표시
        const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
        modal.show();

      } catch (error) {
        console.error('Error in editReservationModal:', error);
        alert('예약 수정 모달을 열 수 없습니다: ' + error.message);
      }
    }

    // 날짜 유효성 검사
    function isValidDateFormat(dateString) {
      if (!dateString) return false;
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
      return dateRegex.test(dateString);
    }

    // 수정 모달 열기 함수 분리
    async function openEditModal(reservation) {
      try {
        // 날짜 형식 변환
        const checkinDate = formatDateForInput(reservation.checkinDt);
        const checkoutDate = formatDateForInput(reservation.checkoutDt);

        console.log('Checking availability for:', {
          checkinDate,
          checkoutDate,
          reservationId: reservation.id
        });

        // 객실 정보와 예약된 객실 정보 모두 가져오기
        const [roomResponse, occupiedResponse] = await Promise.all([
          fetch('/api/room'),
          fetch(`/api/room/occupied?checkinDate=${checkinDate}&checkoutDate=${checkoutDate}&excludeReservationId=${reservation.id}`)
        ]);

        if (!roomResponse.ok || !occupiedResponse.ok) {
          throw new Error('객실 정보를 불러올 수 없습니다.');
        }

        const [rooms, occupiedRooms] = await Promise.all([
          roomResponse.json(),
          occupiedResponse.json()
        ]);

        console.log('API responses:', {
          rooms,
          occupiedRooms
        });

        // 현재 수정 중인 예약의 객실은 선택 가능하도록 occupiedRooms에서 제외
        const occupiedRoomNumbers = occupiedRooms
          .filter(room => room.reservationId !== reservation.id)
          .map(room => room.roomNumber);

        // 객실 선택 옵션 생성
        const roomSelect = document.getElementById('editRoomSelect');
        roomSelect.innerHTML = '';

        rooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room.roomNumber;
          option.textContent = `${room.roomNumber}호 (${getRoomTypeText(room.roomType)})`;

          const isCurrentRoom = room.roomNumber === reservation.roomNumber;
          const isOccupied = occupiedRoomNumbers.includes(room.roomNumber);

          if (isCurrentRoom || !isOccupied) {
            option.disabled = false;
            if (isCurrentRoom) {
              option.selected = true;
            }
          } else {
            option.disabled = true;
            option.textContent += ' (예약됨)';
          }

          roomSelect.appendChild(option);
        });

        // 수정 모달의 입력 필드 설정
        document.getElementById('editReservationId').value = reservation.id;
        document.getElementById('editCheckinDate').value = checkinDate;
        document.getElementById('editCheckoutDate').value = checkoutDate;

        // 수정 모달 열기
        const editModal = document.getElementById('editReservationModal');
        editModal.removeAttribute('aria-hidden');

        const modal = new bootstrap.Modal(editModal);
        modal.show();

      } catch (error) {
        console.error('Error:', error);
        alert('수정 모달을 열 수 없습니다: ' + error.message);
      }
    }

    // 날짜 변경 시 사용 가능한 객실 업데이트
    async function updateAvailableRooms() {
      try {
        const checkinDate = document.getElementById('editCheckinDate').value;
        const checkoutDate = document.getElementById('editCheckoutDate').value;
        const reservationId = document.getElementById('editReservationId').value;

        if (!checkinDate || !checkoutDate) {
          console.log('날짜가 선택되지 않았습니다.');
          return;
        }

        console.log('Checking availability for:', {
          checkinDate,
          checkoutDate,
          reservationId
        });

        // 객실 정보와 예약된 객실 정보 가져오기
        const response = await fetch(
          `/api/room/occupied?` +
          `checkinDate=${encodeURIComponent(checkinDate)}` +
          `&checkoutDate=${encodeURIComponent(checkoutDate)}` +
          `&excludeReservationId=${encodeURIComponent(reservationId)}`
        );

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server response:', errorText);
          throw new Error('객실 정보를 불러올 수 없습니다.');
        }

        const data = await response.json();
        console.log('API response:', data);

        // 객실 선택 드롭다운 업데이트
        const roomSelect = document.getElementById('editRoomSelect');
        const currentValue = roomSelect.value;

        // 드롭다운 초기화
        roomSelect.innerHTML = '<option value="">객실을 선택해주세요</option>';

        // 객실 목록 생성
        data.rooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room.roomNumber;
          option.textContent = `${room.roomNumber}호 (${getRoomTypeText(room.roomType)})`;

          // 예약된 객실인지 확인
          const isOccupied = data.occupiedRooms.some(
            occupiedRoom => occupiedRoom.roomNumber === room.roomNumber
          );

          if (isOccupied) {
            option.disabled = true;
            option.textContent += ' (예약됨)';
          }

          // 현재 선택된 객실이면 선택 상태 유지
          if (room.roomNumber === currentValue) {
            option.selected = true;
          }

          roomSelect.appendChild(option);
        });

      } catch (error) {
        console.error('Error in updateAvailableRooms:', error);
        throw error;
      }
    }
    // 예약 수정 함수
    async function updateReservation() {
      try {
        const reservationId = document.getElementById('editReservationId').value;
        const roomNumber = document.getElementById('editRoomSelect').value;
        const checkinDate = document.getElementById('editCheckinDate').value;
        const checkoutDate = document.getElementById('editCheckoutDate').value;

        // 입력값 검증
        if (!roomNumber || !checkinDate || !checkoutDate) {
          alert('모든 필수 항목을 입력해주세요.');
          return;
        }

        // 날짜 유효성 검사
        if (new Date(checkinDate) >= new Date(checkoutDate)) {
          alert('체크아웃 날짜는 체크인 날짜보다 뒤여야 합니다.');
          return;
        }

        const response = await fetch(`/api/reservation/customer/${reservationId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            roomNumber: roomNumber,
            checkinDt: checkinDate,
            checkoutDt: checkoutDate
          })
        });

        if (!response.ok) throw new Error('예약 수정에 실패했습니다.');

        const result = await response.json();
        if (result.success) {
          alert('예약이 수정되었습니다.');

          // 수정 모달 닫기
          const editModal = document.getElementById('editReservationModal');
          const modal = bootstrap.Modal.getInstance(editModal);

          // 포커스 처리 및 모달 닫기
          document.body.focus();
          modal.hide();

          // 예약 목록 새로고침
          setTimeout(() => {
            checkReservation(currentCustomerId);
          }, 100);
        }
      } catch (error) {
        console.error('Error:', error);
        alert(error.message);
      }
    }
    // 객실 타입 변환 함수
    function getRoomTypeText(type) {
      const roomTypes = {
        'NORMAL': '일반',
        'SUITE': '스위트',
        'BUSINESS': '비즈니스',
        'VIP': 'VIP'
      };
      return roomTypes[type] || type;
    }

    // 날짜를 input type="date"에 맞는 형식으로 변환
    // 날짜 형식 변환 함수들
    function formatDateForInput(dateString) {
      try {
        if (!dateString) return '';

        // 날짜 문자열에서 시간 부분 제거
        const datePart = dateString.split(' ')[0];

        // YYYY-MM-DD 형식 확인
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (dateRegex.test(datePart)) {
          return datePart;
        }

        console.log('Original date string:', dateString);
        console.log('Parsed date part:', datePart);

        // 다른 형식일 경우 수동으로 파싱
        const parts = datePart.split('-');
        if (parts.length === 3) {
          const year = parts[0];
          const month = parts[1].padStart(2, '0');
          const day = parts[2].padStart(2, '0');
          return `${year}-${month}-${day}`;
        }

        throw new Error('Unsupported date format');
      } catch (error) {
        console.error('Error formatting date:', error, dateString);
        return '';
      }
    }


    // 예약 삭제 처리
    async function deleteReservation(reservationId) {
      if (!confirm('정말로 이 예약을 삭제하시겠습니까?')) return;

      try {
        const response = await fetch(`/api/reservation/${reservationId}`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete reservation');

        const data = await response.json();
        if (data.success) {
          alert('예약이 삭제되었습니다.');
          // 예약 목록 새로고침
          checkReservation(currentCustomerId);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('예약 삭제에 실패했습니다.');
      }
    }

    // 날짜 입력용 포맷 함수
    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      return date.toISOString().split('T')[0];
    }
    // 날짜 포맷 함수
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // 날짜시간 포맷 함수
    function formatDateTime(dateTimeString) {
      if (!dateTimeString) return '-';
      const date = new Date(dateTimeString);
      return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    // 사이드바 로드 함수 수정
    function loadSidebar() {
      fetch('/html/components/sidebar.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('sidebarContainer').innerHTML = html;

          // 스크립트 실행
          const scriptContent = html.match(/<script id="sidebarScript">([\s\S]*?)<\/script>/);
          if (scriptContent && scriptContent[1]) {
            eval(scriptContent[1]);  // 스크립트 직접 실행

            // 현재 페이지 메뉴 활성화
            const customerLink = document.getElementById('nav-customer');
            if (customerLink) {
              customerLink.classList.add('active');
            }
          }
        })
        .catch(error => console.error('Error loading sidebar:', error));
    }

    // 페이지 초기화 부분 수정 (362-369번 라인)
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Customer Management page loaded');
      loadSidebar();
      loadCustomers();
      checkSession();

      // 고객 추가 버튼 클릭 이벤트 리스너 추가
      document.getElementById('addCustomerBtn').addEventListener('click', function () {
        // 모달 초기화
        document.getElementById('addUsername').value = '';
        document.getElementById('addPassword').value = '';
        document.getElementById('addName').value = '';
        document.getElementById('addEmail').value = '';
        document.getElementById('usernameCheck').innerHTML = '';
        document.getElementById('emailCheck').innerHTML = '';
        isUsernameAvailable = false;
        isEmailAvailable = false;

        // 모달 열기
        const modal = new bootstrap.Modal(document.getElementById('addModal'));
        // 체크인/체크아웃 날짜 변경 이벤트 리스너
        document.getElementById('editCheckinDate').addEventListener('change', updateAvailableRooms);
        document.getElementById('editCheckoutDate').addEventListener('change', updateAvailableRooms);
        modal.show();
      });
    });

    // 검색 이벤트 리스너 설정
    const searchInput = document.getElementById('searchInput');
    const searchType = document.getElementById('searchType');

    let debounceTimer;
    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        searchCustomers();
      }, 300);
    });

    searchType.addEventListener('change', () => {
      searchCustomers();
    });

    // 정렬 이벤트 리스너 설정
    document.querySelectorAll('.sortable').forEach(header => {
      header.addEventListener('click', () => {
        sortCustomers(header.dataset.sort);
      });
    });

    // 실시간 아이디 중복 확인
    async function checkUsernameReal(username) {
      const checkResult = document.getElementById('usernameCheck');

      if (!username) {
        checkResult.innerHTML = '아이디를 입력해주세요.';
        checkResult.className = 'form-text text-danger';
        isUsernameAvailable = false;
        return;
      }

      try {
        const response = await fetch(`/api/check-username?username=${encodeURIComponent(username)}`);
        const data = await response.json();

        if (data.available) {
          checkResult.innerHTML = '사용 가능한 아이디입니다.';
          checkResult.className = 'form-text text-success';
          isUsernameAvailable = true;
        } else {
          checkResult.innerHTML = '이미 사용중인 아이디입니다.';
          checkResult.className = 'form-text text-danger';
          isUsernameAvailable = false;
        }
      } catch (error) {
        console.error('Error:', error);
        checkResult.innerHTML = '중복 확인 중 오류가 발생했습니다.';
        checkResult.className = 'form-text text-danger';
        isUsernameAvailable = false;
      }
    }

    // 실시간 이메일 중복 확인
    async function checkEmailReal(email) {
      const checkResult = document.getElementById('emailCheck');
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;

      if (!email) {
        checkResult.innerHTML = '이메일을 입력해주세요.';
        checkResult.className = 'form-text text-danger';
        isEmailAvailable = false;
        return;
      }

      if (!emailRegex.test(email)) {
        checkResult.innerHTML = '올바른 이메일 형식이 아닙니다.';
        checkResult.className = 'form-text text-danger';
        isEmailAvailable = false;
        return;
      }

      try {
        const response = await fetch(`/api/check-email?email=${encodeURIComponent(email)}`);
        const data = await response.json();

        if (data.available) {
          checkResult.innerHTML = '사용 가능한 이메일입니다.';
          checkResult.className = 'form-text text-success';
          isEmailAvailable = true;
        } else {
          checkResult.innerHTML = '이미 사용중인 이메일입니다.';
          checkResult.className = 'form-text text-danger';
          isEmailAvailable = false;
        }
      } catch (error) {
        console.error('Error:', error);
        checkResult.innerHTML = '중복 확인 중 오류가 발생했습니다.';
        checkResult.className = 'form-text text-danger';
        isEmailAvailable = false;
      }
    }

    // 고객 목록 로드
    async function loadCustomers() {
      try {
        const response = await fetch('/api/customer');
        if (!response.ok) throw new Error('Failed to load customers');

        const data = await response.json();
        totalCustomers = Array.isArray(data) ? data : [];

        displayCustomers(currentPage);
        updatePagination();
      } catch (error) {
        console.error('Error:', error);
        alert('고객 목록을 불러오는데 실패했습니다.');
      }
    }

    // 고객 검색
    async function searchCustomers() {
      const searchType = document.getElementById('searchType').value;
      const searchTerm = document.getElementById('searchInput').value.trim();

      try {
        let url = '/api/customer';
        if (searchTerm) {
          url += `?type=${searchType}&term=${encodeURIComponent(searchTerm)}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        totalCustomers = Array.isArray(data) ? data : [];
        currentPage = 1;

        displayCustomers(currentPage);
        updatePagination();
      } catch (error) {
        console.error('Error:', error);
        alert('검색 중 오류가 발생했습니다.');
      }
    }

    // 고객 목록 표시
    function displayCustomers(page) {
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedCustomers = totalCustomers.slice(start, end);

      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';

      paginatedCustomers.forEach(customer => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${customer.id}</td>
          <td>${customer.username}</td>
          <td>${customer.name}</td>
          <td>${customer.email}</td>
          <td>
            <button class="btn btn-sm btn-info me-1" onclick="checkReservation(${customer.id})">
        예약 확인
            </button>
            <button class="btn btn-sm btn-primary me-1" onclick="editCustomer(${customer.id})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 페이지네이션 업데이트
    function updatePagination() {
      const totalPages = Math.ceil(totalCustomers.length / itemsPerPage);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      // 처음으로 버튼
      const firstLi = document.createElement('li');
      firstLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      firstLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(1)">
          <i class="fas fa-angle-double-left"></i>
        </a>
      `;
      pagination.appendChild(firstLi);

      // 이전 페이지 버튼
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
          <i class="fas fa-angle-left"></i>
        </a>
      `;
      pagination.appendChild(prevLi);

      // 페이지 번호 (최대 7개)
      let startPage = Math.max(1, currentPage - 3);
      let endPage = Math.min(totalPages, startPage + 6);

      // 끝부분 처리
      if (endPage - startPage < 6) {
        startPage = Math.max(1, endPage - 6);
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${currentPage === i ? 'active' : ''}`;
        li.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        `;
        pagination.appendChild(li);
      }

      // 다음 페이지 버튼
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
          <i class="fas fa-angle-right"></i>
        </a>
      `;
      pagination.appendChild(nextLi);

      // 마지막으로 버튼
      const lastLi = document.createElement('li');
      lastLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      lastLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${totalPages})">
          <i class="fas fa-angle-double-right"></i>
        </a>
      `;
      pagination.appendChild(lastLi);
    }

    // 페이지 변경
    function changePage(page) {
      if (page < 1 || page > Math.ceil(totalCustomers.length / itemsPerPage)) return;
      currentPage = page;
      displayCustomers(currentPage);
      updatePagination();
    }

    // 고객 정렬
    function sortCustomers(field) {
      const header = document.querySelector(`[data-sort="${field}"]`);
      const isAsc = !header.classList.contains('asc');

      // 모든 헤더의 정렬 클래스 제거
      document.querySelectorAll('.sortable').forEach(h => {
        h.classList.remove('asc', 'desc');
      });

      // 현재 헤더에 정렬 클래스 추가
      header.classList.add(isAsc ? 'asc' : 'desc');

      totalCustomers.sort((a, b) => {
        const aVal = a[field];
        const bVal = b[field];

        if (typeof aVal === 'string') {
          return isAsc ?
            aVal.localeCompare(bVal) :
            bVal.localeCompare(aVal);
        }
        return isAsc ? aVal - bVal : bVal - aVal;
      });

      displayCustomers(currentPage);
    }

    // 추가 모달 초기화
    function cancelAdd() {
      document.getElementById('addUsername').value = '';
      document.getElementById('addPassword').value = '';
      document.getElementById('addName').value = '';
      document.getElementById('addEmail').value = '';
      document.getElementById('usernameCheck').innerHTML = '';
      document.getElementById('emailCheck').innerHTML = '';
      isUsernameAvailable = false;
      isEmailAvailable = false;
      const modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
      if (modal) modal.hide();
    }

    // 고객 추가
    async function addCustomer() {
      const username = document.getElementById('addUsername').value.trim();
      const password = document.getElementById('addPassword').value.trim();
      const name = document.getElementById('addName').value.trim();
      const email = document.getElementById('addEmail').value.trim();

      if (!username || !password || !name || !email) {
        alert('모든 필수 항목을 입력해주세요.');
        return;
      }

      if (!isUsernameAvailable || !isEmailAvailable) {
        alert('아이디와 이메일 중복 확인이 필요합니다.');
        return;
      }

      try {
        const response = await fetch('/api/customer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username,
            password,
            name,
            email
          })
        });

        if (!response.ok) throw new Error('Failed to add customer');

        const data = await response.json();
        if (data.success) {
          alert('고객이 추가되었습니다.');
          cancelAdd();
          loadCustomers();
        } else {
          alert('고객 추가에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('고객 추가 중 오류가 발생했습니다.');
      }
    }

    // 고객 수정 모달 열기
    function editCustomer(id) {
      const customer = totalCustomers.find(c => c.id === id);
      if (customer) {
        originalCustomerData = { ...customer };
        document.getElementById('editId').value = customer.id;
        document.getElementById('editUsername').value = customer.username;
        document.getElementById('editName').value = customer.name;
        document.getElementById('editEmail').value = customer.email;
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
      }
    }

    // 수정 시 이메일 실시간 검증
    async function checkEditEmailReal(email) {
      const checkResult = document.getElementById('editEmailCheck');
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;

      if (!email) {
        checkResult.innerHTML = '이메일을 입력해주세요.';
        checkResult.className = 'form-text text-danger';
        return false;
      }

      if (!emailRegex.test(email)) {
        checkResult.innerHTML = '올바른 이메일 형식이 아닙니다.';
        checkResult.className = 'form-text text-danger';
        return false;
      }

      // 원래 이메일과 같으면 중복 체크 스킵
      if (email === originalCustomerData.email) {
        checkResult.innerHTML = '사용 가능한 이메일입니다.';
        checkResult.className = 'form-text text-success';
        return true;
      }

      try {
        const response = await fetch(`/api/check-email?email=${encodeURIComponent(email)}`);
        const data = await response.json();

        if (data.available) {
          checkResult.innerHTML = '사용 가능한 이메일입니다.';
          checkResult.className = 'form-text text-success';
          return true;
        } else {
          checkResult.innerHTML = '이미 사용중인 이메일입니다.';
          checkResult.className = 'form-text text-danger';
          return false;
        }
      } catch (error) {
        console.error('Error:', error);
        checkResult.innerHTML = '중복 확인 중 오류가 발생했습니다.';
        checkResult.className = 'form-text text-danger';
        return false;
      }
    }

    // updateCustomer 함수 수정
    async function updateCustomer() {
      const id = document.getElementById('editId').value;
      const name = document.getElementById('editName').value.trim();
      const email = document.getElementById('editEmail').value.trim();

      if (!name || !email) {
        alert('모든 필수 항목을 입력해주세요.');
        return;
      }

      // 이메일 유효성 검사
      if (!await checkEditEmailReal(email)) {
        alert('올바른 이메일을 입력해주세요.');
        return;
      }

      try {
        const response = await fetch(`/api/customer/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name,
            email
          })
        });

        if (!response.ok) throw new Error('Failed to update customer');

        const data = await response.json();
        if (data.success) {
          alert('고객 정보가 수정되었습니다.');
          const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
          modal.hide();
          loadCustomers();
        } else {
          alert('고객 정보 수정에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('고객 정보 수정 중 오류가 발생했습니다.');
      }
    }

    // 고객 삭제
    async function deleteCustomer(id) {
      if (!confirm('정말로 이 고객을 삭제하시겠습니까?')) return;

      try {
        const response = await fetch(`/api/customer/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete customer');

        const data = await response.json();
        if (data.success) {
          alert('고객이 삭제되었습니다.');
          loadCustomers();
        } else {
          alert('고객 삭제에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('고객 삭제 중 오류가 발생했습니다.');
      }
    }

    // 세션 체크
    function checkSession() {
      fetch('/api/check-session')
        .then(response => {
          if (!response.ok) {
            window.location.href = '/login';
          }
        })
        .catch(() => {
          window.location.href = '/login';
        });
    }

    // 페이지 로드 및 포커스 시 세션 체크
    document.addEventListener('DOMContentLoaded', checkSession);
    window.addEventListener('focus', checkSession);

    // 뒤로가기 감지 및 세션 체크
    window.addEventListener('pageshow', function (event) {
      if (event.persisted) {
        checkSession();
      }
    });
  </script>
</body>

</html>